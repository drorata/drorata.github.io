<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


  <title>Comparing $z$ and $\chi^2$ tests | Dr. Dror
</title>
  <link rel="canonical" href="../../../../../posts/2018/Feb/19/comparing-z-and-chi2-tests/index.html">


  <link rel="stylesheet" href="../../../../../theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="../../../../../theme/css/fontawesome.min.css">
  <link rel="stylesheet" href="../../../../../theme/css/pygments/default.min.css">
  <link rel="stylesheet" href="../../../../../theme/css/theme.css">


<meta name="description" content="Showing that at least in one certain case the two tests are the same">
  <!-- Global site tag (gtag.js) - Google Analytics --> 
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-WH47T9F1TR"></script> 
  <script> 
    window.dataLayer = window.dataLayer || []; 
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date()); 

    gtag('config', 'G-WH47T9F1TR'); 
  </script>


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
    <div class="col-sm-4">
      <a href="../../../../../">
        <img class="img-fluid rounded" src=../../../../../images/colored-spiral-of-roots.png width=90 height=90 alt="Dr. Dror">
      </a>
    </div>
  <div class="col-sm-8">
    <h1 class="title"><a href="../../../../../">Dr. Dror</a></h1>
      <p class="text-muted">Foo is not just a "Bar"</p>
      <ul class="list-inline">
            <li class="list-inline-item"><a href="../../../../../pages/about.html">About</a></li>
              <li class="list-inline-item text-muted">/</li>
            <li class="list-inline-item"><a href="../../../../../pages/random-work.html">Random work</a></li>
            <li class=" list-inline-item text-muted">|</li>
          <li class="list-inline-item"><a class="fab fa-github" href="https://github.com/drorata" target="_blank"></a></li>
          <li class="list-inline-item"><a class="fab fa-linkedin" href="https://www.linkedin.com/in/atariah" target="_blank"></a></li>
      </ul>
  </div>
</div>    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>  Comparing $z$ and $\chi^2$ tests
</h1>
      <hr>
<article class="article">
  <header>
    <ul class="list-inline">
      <li class="list-inline-item text-muted" title="2018-02-19T00:00:00+01:00">
        <i class="fas fa-clock"></i>
        Mon 19 February 2018
      </li>
      <li class="list-inline-item">
        <i class="fas fa-folder-open"></i>
        <a href="../../../../../category/stats.html">Stats</a>
      </li>
      <li class="list-inline-item">
        <i class="fas fa-tag"></i>
        <a href="../../../../../tag/hypothesis.html">#hypothesis</a>,         <a href="../../../../../tag/testing.html">#testing</a>,         <a href="../../../../../tag/z-test.html">#z-test</a>,         <a href="../../../../../tag/chi2-test.html">#chi2-test</a>      </li>
    </ul>
  </header>
  <div class="content">
    <p>This post is a snapshot of a notebook that can be found here: <a href="https://github.com/drorata/z-vs-ch2-tests/blob/fd870a67cbe3b9e44d397e50a8883919d676e8bf/compare%20z%20and%20chi%20square%20tests.ipynb">(fd870a6)</a>.
You can also enjoy the binder version of this notebook <a href="https://mybinder.org/v2/gh/drorata/z-vs-ch2-tests/master"><img alt="Binder" src="https://mybinder.org/badge.svg"></a></p>
<hr>

<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats</span> <span class="kn">import</span> <span class="n">proportion</span>

<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interact</span><span class="p">,</span> <span class="n">interactive</span><span class="p">,</span> <span class="n">fixed</span><span class="p">,</span> <span class="n">interact_manual</span>
<span class="kn">import</span> <span class="nn">ipywidgets</span> <span class="k">as</span> <span class="nn">widgets</span>

<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;ggplot&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="preface">Preface</h2>
<p>The motivation for this tutorial is to better understand the methods to assess the results of A/B(/C...) tests.
There are so many common pitfalls when it comes to A/B tests; make sure you avoid them!
For example, <a href="https://blog.hubspot.com/marketing/a-b-test-checklist">this check list</a> might be a good reference.</p>
<p>A common and repeating question is how to check the significance of the results of an A/B test.
<a href="https://stats.stackexchange.com/a/178860/54320">Matt Brems</a> provided a very nice summary.
I wanted to compare two of the tests suggested:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Z-test"><span class="math">\(z\)</span>-test</a></li>
<li><a href="https://en.wikipedia.org/wiki/Chi-squared_test"><span class="math">\(\chi^2\)</span>-test</a></li>
</ul>
<h3 id="the-plan">The plan</h3>
<p>Let us define <span class="math">\(N\)</span> to be a set of <span class="math">\(u\)</span> integers and <span class="math">\(\Delta\)</span> to be a set of <span class="math">\(v\)</span> real numbers.
For each <span class="math">\(n \in N\)</span> and <span class="math">\(\delta \in \Delta\)</span> we generate a synthetic results of an A/B test.
In particular the control and variant groups would have <span class="math">\(\sim n\)</span> observations.
The reason is that in real results of A/B tests, the groups sizes are normally not identical; they are close but not equal.
Furthermore, the control set would have a fixed <span class="math">\(\mathrm{CTR}\)</span> (click through rate) and the variant will have conversion rate of <span class="math">\(\mathrm{CTR} + \delta\)</span>.</p>
<p>As the null hypothesis we take that the CTR of the control and variant groups is the same, independently of the treatment.
Thus a small <span class="math">\(p\)</span>-value should suggest to reject the null hypothesis.
For each synthetic result we will compute the <span class="math">\(p\)</span>-value using a <span class="math">\(z\)</span>-test and a <span class="math">\(\chi^2\)</span>-test.
In general, we expect that the smaller <span class="math">\(n\)</span> is and the larger <span class="math">\(\delta\)</span>, the resulting <span class="math">\(p\)</span>-value would be larger.</p>
<h2 id="generate-data">Generate data</h2>
<h3 id="groups-sizes">Groups' sizes</h3>
<p>In reality, even though we assume the users are split randomly and evenly, the final groups' sizes are not identical.
Therefore, we randomize the group size:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">rand_group_size</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">N</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span>
        <span class="nb">min</span><span class="p">(</span><span class="o">-</span><span class="n">tol</span> <span class="o">*</span> <span class="n">N</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
        <span class="nb">max</span><span class="p">(</span><span class="n">tol</span> <span class="o">*</span> <span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<h3 id="events-value">Event's value</h3>
<p>For each successful event we assign a value.
To that end we use a truncated uniform distribution providing the <code>low</code> and <code>up</code> values, together with the mean (<code>mu</code>) and standard deviation (<code>sigma</code>).</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">rand_values</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">truncnorm</span><span class="p">(</span>
        <span class="p">(</span><span class="n">low</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">,</span>
        <span class="p">(</span><span class="n">up</span>  <span class="o">-</span> <span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="n">sigma</span><span class="p">,</span>
        <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</code></pre></div>

<h3 id="generating-the-data-for-a-group">Generating the data for a group</h3>
<p>When generating an observation, the following features are randomized:</p>
<ul>
<li>The group size; controlled by <code>N</code> (~size) and <code>N_tol</code>. See <code>rand_group_size</code></li>
<li>Name of the group. Normally <code>control</code> or <code>var</code>. Configured by <code>treat</code>.</li>
<li>Randomly assign <code>1</code> is the event was converted and <code>0</code> otherwise. The randomness is controlled by the weight<code>ctr</code></li>
<li>In case of conversion what was the value; controlled by: <code>min_val</code>, <code>max_val</code>, <code>mean_val</code> and <code>std_val</code></li>
<li>What day of the test is it; controlled by number of <code>days</code> and the distribution <code>days_dist</code></li>
<li><code>seed</code> can help you reproduce the results.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">generate_group_observations</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">N_tol</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span>
                                <span class="n">treat</span><span class="o">=</span><span class="s1">&#39;control&#39;</span><span class="p">,</span>
                                <span class="n">ctr</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                                <span class="n">min_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">mean_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">std_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">days_dist</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="mi">7</span><span class="p">,</span>
                                <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">seed</span><span class="o">=</span><span class="mi">42</span>
                               <span class="p">):</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generating ~</span><span class="si">{N}</span><span class="s1"> samples with tolerance </span><span class="si">{tol}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">N_tol</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CTR: </span><span class="si">{ctr}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ctr</span><span class="o">=</span><span class="n">ctr</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Min value: </span><span class="si">{min_val}</span><span class="s1"> / Max value: </span><span class="si">{max_val}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_val</span><span class="o">=</span><span class="n">min_val</span><span class="p">,</span>
                                                                   <span class="n">max_val</span><span class="o">=</span><span class="n">max_val</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Value mean: </span><span class="si">{mean_val}</span><span class="s1"> / Value STD: </span><span class="si">{std_val}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">mean_val</span><span class="o">=</span><span class="n">mean_val</span><span class="p">,</span>
                                                                     <span class="n">std_val</span><span class="o">=</span><span class="n">std_val</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Generating observation over </span><span class="si">{days}</span><span class="s1"> days with </span><span class="si">{dist}</span><span class="s1"> as the distribution&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">,</span> <span class="n">dist</span><span class="o">=</span><span class="n">days_dist</span>
        <span class="p">))</span>
    <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">rand_group_size</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">N_tol</span><span class="p">)</span>
    <span class="n">converts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">ctr</span><span class="p">,</span> <span class="n">ctr</span><span class="p">])</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">rand_values</span><span class="p">(</span><span class="n">min_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">mean_val</span><span class="p">,</span> <span class="n">std_val</span><span class="p">,</span> <span class="n">N</span><span class="p">),</span> <span class="n">converts</span><span class="p">)</span>
    <span class="n">day</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">days</span><span class="p">),</span> <span class="n">p</span><span class="o">=</span><span class="n">days_dist</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;Treat&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">treat</span><span class="p">]</span> <span class="o">*</span> <span class="n">N</span><span class="p">,</span>
            <span class="s2">&quot;Day&quot;</span><span class="p">:</span> <span class="n">day</span><span class="p">,</span>
            <span class="s2">&quot;Converted&quot;</span><span class="p">:</span> <span class="n">converts</span><span class="p">,</span>
            <span class="s2">&quot;Value&quot;</span><span class="p">:</span> <span class="n">values</span>
        <span class="p">}</span>
    <span class="p">)</span>
</code></pre></div>

<p>Here is an example of ~10 observation (for a single group) spread along two days</p>
<div class="highlight"><pre><span></span><code><span class="n">generate_group_observations</span><span class="p">(</span>
    <span class="n">N</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">days_dist</span><span class="o">=</span><span class="p">[</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">],</span>
    <span class="n">min_val</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">mean_val</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">std_val</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">314</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code>Generating ~10 samples with tolerance 0.05
CTR: 0.2
Min value: 30 / Max value: 100
Value mean: 60 / Value STD: 20
Generating observation over 2 days with [0.4, 0.6] as the distribution
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Converted</th>
      <th>Day</th>
      <th>Treat</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>control</td>
      <td>58.682799</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0</td>
      <td>1</td>
      <td>control</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>1</td>
      <td>control</td>
      <td>83.425302</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>0</td>
      <td>control</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>0</td>
      <td>control</td>
      <td>37.115954</td>
    </tr>
    <tr>
      <th>5</th>
      <td>1</td>
      <td>0</td>
      <td>control</td>
      <td>85.991153</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0</td>
      <td>1</td>
      <td>control</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>0</td>
      <td>1</td>
      <td>control</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>8</th>
      <td>1</td>
      <td>1</td>
      <td>control</td>
      <td>53.225721</td>
    </tr>
  </tbody>
</table>
</div>

<p>We are now ready to generate a synthetic results set of an A/B test, using the following function.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">generate_observations</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                          <span class="n">control_ctr</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                          <span class="n">control_min_value</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                          <span class="n">control_max_value</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                          <span class="n">control_mean_sale</span><span class="o">=</span><span class="mi">80</span><span class="p">,</span>
                          <span class="n">control_std_sale</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                          <span class="n">var_ctr</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span>
                          <span class="n">var_min_value</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                          <span class="n">var_max_value</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span>
                          <span class="n">var_mean_sale</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span>
                          <span class="n">var_std_sale</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
                          <span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">days_dist</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="mi">7</span><span class="p">]</span> <span class="o">*</span> <span class="mi">7</span><span class="p">,</span>
                          <span class="n">seed</span><span class="o">=</span><span class="mi">42</span><span class="p">,</span>
                          <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
                         <span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">generate_group_observations</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">,</span> <span class="n">days_dist</span><span class="o">=</span><span class="n">days_dist</span><span class="p">,</span>
                                          <span class="n">ctr</span><span class="o">=</span><span class="n">control_ctr</span><span class="p">,</span> <span class="n">min_val</span><span class="o">=</span><span class="n">control_min_value</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="n">control_max_value</span><span class="p">,</span>
                                          <span class="n">mean_val</span><span class="o">=</span><span class="n">control_mean_sale</span><span class="p">,</span> <span class="n">std_val</span><span class="o">=</span><span class="n">control_std_sale</span><span class="p">,</span>
                                          <span class="n">treat</span><span class="o">=</span><span class="s1">&#39;control&#39;</span><span class="p">,</span>
                                          <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
                                         <span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">generate_group_observations</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">days</span><span class="o">=</span><span class="n">days</span><span class="p">,</span> <span class="n">days_dist</span><span class="o">=</span><span class="n">days_dist</span><span class="p">,</span>
                                      <span class="n">ctr</span><span class="o">=</span><span class="n">var_ctr</span><span class="p">,</span> <span class="n">min_val</span><span class="o">=</span><span class="n">var_min_value</span><span class="p">,</span> <span class="n">max_val</span><span class="o">=</span><span class="n">var_max_value</span><span class="p">,</span>
                                      <span class="n">mean_val</span><span class="o">=</span><span class="n">var_mean_sale</span><span class="p">,</span> <span class="n">std_val</span><span class="o">=</span><span class="n">var_std_sale</span><span class="p">,</span>
                                      <span class="n">treat</span><span class="o">=</span><span class="s1">&#39;var&#39;</span><span class="p">,</span>
                                      <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
                                     <span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">control</span><span class="p">,</span> <span class="n">var</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<p>Here's a ~10 days X 2 (for <em>control</em> and <em>variation</em> groups) results set</p>
<div class="highlight"><pre><span></span><code><span class="n">generate_observations</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">262</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Converted</th>
      <th>Day</th>
      <th>Treat</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>1</td>
      <td>control</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>6</td>
      <td>control</td>
      <td>90.575667</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0</td>
      <td>2</td>
      <td>control</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0</td>
      <td>0</td>
      <td>control</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0</td>
      <td>3</td>
      <td>control</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>0</td>
      <td>6</td>
      <td>control</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>0</td>
      <td>3</td>
      <td>control</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>1</td>
      <td>5</td>
      <td>control</td>
      <td>88.962021</td>
    </tr>
    <tr>
      <th>8</th>
      <td>0</td>
      <td>2</td>
      <td>control</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>9</th>
      <td>0</td>
      <td>3</td>
      <td>control</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>10</th>
      <td>0</td>
      <td>6</td>
      <td>var</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>11</th>
      <td>0</td>
      <td>6</td>
      <td>var</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>12</th>
      <td>1</td>
      <td>6</td>
      <td>var</td>
      <td>61.830611</td>
    </tr>
    <tr>
      <th>13</th>
      <td>0</td>
      <td>2</td>
      <td>var</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>14</th>
      <td>0</td>
      <td>1</td>
      <td>var</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>15</th>
      <td>0</td>
      <td>6</td>
      <td>var</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>16</th>
      <td>0</td>
      <td>6</td>
      <td>var</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>17</th>
      <td>1</td>
      <td>4</td>
      <td>var</td>
      <td>74.639051</td>
    </tr>
    <tr>
      <th>18</th>
      <td>0</td>
      <td>0</td>
      <td>var</td>
      <td>0.000000</td>
    </tr>
  </tbody>
</table>
</div>

<h2 id="conversion-rate">Conversion rate</h2>
<p>At this point we want to aggregate the results and compute the metric (a.k.a. proportion) we are after.
In this example we consider the conversion rate.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">agg_conversion</span><span class="p">(</span><span class="n">results</span><span class="p">):</span>
    <span class="n">conversions</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Treat&#39;</span><span class="p">)[</span><span class="s1">&#39;Converted&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">([</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">])</span>
    <span class="n">conversions</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="s1">&#39;Visitors&#39;</span><span class="p">,</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span> <span class="s1">&#39;Converted&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">conversions</span><span class="p">[</span><span class="s1">&#39;Not_converted&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversions</span><span class="o">.</span><span class="n">Visitors</span> <span class="o">-</span> <span class="n">conversions</span><span class="o">.</span><span class="n">Converted</span>
    <span class="n">conversions</span><span class="p">[</span><span class="s1">&#39;CR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversions</span><span class="o">.</span><span class="n">Converted</span> <span class="o">/</span> <span class="n">conversions</span><span class="o">.</span><span class="n">Visitors</span>
    <span class="k">return</span> <span class="n">conversions</span>
</code></pre></div>

<p>For the conversion rate we aggregate the raw events into a <em>contingency</em> matrix.
Here is the resulting aggregation of the data generated previously.</p>
<div class="highlight"><pre><span></span><code><span class="n">agg_conversion</span><span class="p">(</span><span class="n">generate_observations</span><span class="p">(</span><span class="n">N</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">262</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</code></pre></div>

<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Visitors</th>
      <th>Converted</th>
      <th>Not_converted</th>
      <th>CR</th>
    </tr>
    <tr>
      <th>Treat</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>control</th>
      <td>10</td>
      <td>2</td>
      <td>8</td>
      <td>0.200000</td>
    </tr>
    <tr>
      <th>var</th>
      <td>9</td>
      <td>2</td>
      <td>7</td>
      <td>0.222222</td>
    </tr>
  </tbody>
</table>
</div>

<h3 id="conversion-rate-and-sample-size">Conversion rate and sample size</h3>
<p>In this example (you have to run the notebook interactively) you can witness how the smaller the sample size is the further off the conversion rate is from the one prescribed in the generation function.</p>
<ol>
<li>Fix the conversion rate for the control and variation groups</li>
<li>Play around with <span class="math">\(N\)</span>. Note that the larger <span class="math">\(N\)</span> is the aggregation of the results gets closers to the values set.</li>
</ol>
<p>For every value of <span class="math">\(N\)</span> we generate a synthetic data set and aggregate it to get the observed <em>conversion rate</em>.
The synthetic</p>
<div class="highlight"><pre><span></span><code><span class="n">interact</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">N</span><span class="p">,</span> <span class="n">control_ctr</span><span class="p">,</span> <span class="n">var_ctr</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span>
        <span class="n">agg_conversion</span><span class="p">(</span>
            <span class="n">generate_observations</span><span class="p">(</span>
                <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span>
                <span class="n">control_ctr</span><span class="o">=</span><span class="n">control_ctr</span><span class="p">,</span>
                <span class="n">var_ctr</span><span class="o">=</span><span class="n">var_ctr</span>
            <span class="p">))[</span><span class="s1">&#39;CR&#39;</span><span class="p">]</span>
        <span class="p">),</span>
    <span class="n">control_ctr</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Control CR&#39;</span><span class="p">),</span>
    <span class="n">var_ctr</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">FloatSlider</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Variation CR&#39;</span><span class="p">),</span>
    <span class="n">N</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">IntSlider</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="nb">max</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span><span class="n">step</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">value</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>

<p>Failed to display Jupyter Widget of type <code>interactive</code>.</p>
<p>
  If you're reading this message in the Jupyter Notebook or JupyterLab Notebook, it may mean
  that the widgets JavaScript is still loading. If this message persists, it
  likely means that the widgets JavaScript library is either not installed or
  not enabled. See the <a href="https://ipywidgets.readthedocs.io/en/stable/user_install.html">Jupyter
  Widgets Documentation</a> for setup instructions.
</p>
<p>
  If you're reading this message in another frontend (for example, a static
  rendering on GitHub or <a href="https://nbviewer.jupyter.org/">NBViewer</a>),
  it may mean that your frontend doesn't currently support widgets.
</p>

<h2 id="experimenting-with-different-statistical-tests">Experimenting with different statistical tests</h2>
<p>First, here is a simple utility to plot a heat map of the the resulting <span class="math">\(p\)</span>-values.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">plot_experiment</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility function to plot a heatmap of the resulting p-values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Blues</span><span class="p">,</span> <span class="n">linecolor</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span>
                     <span class="n">xticklabels</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                     <span class="n">linewidths</span><span class="o">=</span><span class="mf">.02</span>
                    <span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;CR delta&#39;</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;N&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">Ns</span><span class="p">);</span>
</code></pre></div>

<p>As discussed in the outline, we generate results for various <span class="math">\(n\)</span>'s and various CTRs of the variant group.</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">generate_data</span><span class="p">(</span><span class="n">control_ctr</span><span class="p">,</span> <span class="n">deltas</span><span class="p">,</span> <span class="n">Ns</span><span class="p">,</span> <span class="n">seeds_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate data for len(Ns)*len(deltas) experiment.</span>
<span class="sd">    Each experiment has ~N observation in each group and</span>
<span class="sd">    the CTR of the variation is control_ctr+delta</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">seeds_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seeds_seed</span><span class="p">)</span>
    <span class="n">seeds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">32</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Ns</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">deltas</span><span class="p">)))</span>
    <span class="n">experiments</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span>
            <span class="n">generate_observations</span><span class="p">(</span>
                <span class="n">N</span><span class="o">=</span><span class="n">N</span><span class="p">,</span> <span class="n">control_ctr</span><span class="o">=</span><span class="n">control_ctr</span><span class="p">,</span>
                <span class="n">var_ctr</span> <span class="o">=</span> <span class="n">control_ctr</span> <span class="o">+</span> <span class="n">delta</span><span class="p">,</span>
                <span class="n">seed</span><span class="o">=</span><span class="n">seeds</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="k">if</span> <span class="n">seeds_seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span> <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">delta</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">deltas</span><span class="p">)</span>
        <span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Ns</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">experiments</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">Ns</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">deltas</span><span class="p">)</span>
</code></pre></div>

<p><em>Finally</em>, generating the data:</p>
<div class="highlight"><pre><span></span><code><span class="n">deltas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">31</span><span class="p">)</span>
<span class="n">Ns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">40</span><span class="p">))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int64&#39;</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">generate_data</span><span class="p">(</span><span class="n">seeds_seed</span><span class="o">=</span><span class="mi">262</span><span class="p">,</span> <span class="n">control_ctr</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
                     <span class="n">deltas</span><span class="o">=</span><span class="n">deltas</span><span class="p">,</span> <span class="n">Ns</span><span class="o">=</span><span class="n">Ns</span><span class="p">,</span>
                    <span class="p">)</span>
</code></pre></div>

<p>For each A/B test we aggregate the data:</p>
<div class="highlight"><pre><span></span><code><span class="n">data_agg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="n">agg_conversion</span><span class="p">)</span>
</code></pre></div>

<p>Utility function to element-wise <span class="math">\(p\)</span>-value computation:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">compute_proportions_pvals</span><span class="p">(</span><span class="n">data_agg</span><span class="p">,</span> <span class="n">test</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compute the p-value of a single A/B test.</span>
<span class="sd">    `test` is assumed to be from `statsmodels.stats.proportion`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">data_agg</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">test</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;Converted&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;Visitors&#39;</span><span class="p">])[</span><span class="mi">1</span><span class="p">])</span>
</code></pre></div>

<h4 id="chi2-independence-test"><span class="math">\(\chi^2\)</span> independence test</h4>
<div class="highlight"><pre><span></span><code><span class="n">pvals_chi2</span> <span class="o">=</span> <span class="n">compute_proportions_pvals</span><span class="p">(</span><span class="n">data_agg</span><span class="p">,</span> <span class="n">proportion</span><span class="o">.</span><span class="n">proportions_chisquare</span><span class="p">)</span>
<span class="n">plot_experiment</span><span class="p">(</span><span class="n">pvals_chi2</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="o">/</span><span class="nx">Users</span><span class="o">/</span><span class="nx">drorata</span><span class="o">/</span><span class="nx">anaconda3</span><span class="o">/</span><span class="nx">envs</span><span class="o">/</span><span class="nx">z</span><span class="o">-</span><span class="nx">vs</span><span class="o">-</span><span class="nx">ch2</span><span class="o">-</span><span class="nx">tests</span><span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">python3</span><span class="m m-Double">.6</span><span class="o">/</span><span class="nx">site</span><span class="o">-</span><span class="nx">packages</span><span class="o">/</span><span class="nx">scipy</span><span class="o">/</span><span class="nx">stats</span><span class="o">/</span><span class="nx">stats</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span><span class="mi">4554</span><span class="p">:</span><span class="w"> </span><span class="nx">RuntimeWarning</span><span class="p">:</span><span class="w"> </span><span class="nx">invalid</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="nx">encountered</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">true_divide</span>
<span class="w">  </span><span class="nx">terms</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">(</span><span class="nx">f_obs</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">f_exp</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">f_exp</span>
</code></pre></div>

<p><img alt="png" src="../../../../../images/compare_z_and_chi_square_tests_32_1.png"></p>
<h3 id="z-test"><span class="math">\(z\)</span> test</h3>
<div class="highlight"><pre><span></span><code><span class="n">pvals_z</span> <span class="o">=</span> <span class="n">compute_proportions_pvals</span><span class="p">(</span><span class="n">data_agg</span><span class="p">,</span> <span class="n">proportion</span><span class="o">.</span><span class="n">proportions_ztest</span><span class="p">)</span>
<span class="n">plot_experiment</span><span class="p">(</span><span class="n">pvals_z</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="o">/</span><span class="nx">Users</span><span class="o">/</span><span class="nx">drorata</span><span class="o">/</span><span class="nx">anaconda3</span><span class="o">/</span><span class="nx">envs</span><span class="o">/</span><span class="nx">z</span><span class="o">-</span><span class="nx">vs</span><span class="o">-</span><span class="nx">ch2</span><span class="o">-</span><span class="nx">tests</span><span class="o">/</span><span class="nx">lib</span><span class="o">/</span><span class="nx">python3</span><span class="m m-Double">.6</span><span class="o">/</span><span class="nx">site</span><span class="o">-</span><span class="nx">packages</span><span class="o">/</span><span class="nx">statsmodels</span><span class="o">/</span><span class="nx">stats</span><span class="o">/</span><span class="nx">weightstats</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span><span class="mi">670</span><span class="p">:</span><span class="w"> </span><span class="nx">RuntimeWarning</span><span class="p">:</span><span class="w"> </span><span class="nx">invalid</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="nx">encountered</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">double_scalars</span>
<span class="w">  </span><span class="nx">zstat</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nx">std_diff</span>
</code></pre></div>

<p><img alt="png" src="../../../../../images/compare_z_and_chi_square_tests_34_1.png"></p>
<h2 id="comparing-z-test-and-chi2-test">Comparing <span class="math">\(z\)</span>-test and <span class="math">\(\chi^2\)</span> test</h2>
<p>The results of the element-wise <span class="math">\(z\)</span> and <span class="math">\(\chi^2\)</span> tests yields an expected visualization.
The smaller the number of samples per group <span class="math">\(N\)</span> is and the smaller <span class="math">\(\delat\)</span> is we have <span class="math">\(p\)</span>-values that are larger.
But, and it is not a huge surprise, the visuals for the two different tests seems similar.
Let us check how close are they.</p>
<div class="highlight"><pre><span></span><code><span class="n">pvals_diffs_close</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">pvals_chi2</span><span class="p">,</span> <span class="n">pvals_z</span><span class="p">))</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">pvals_diffs</span> <span class="o">=</span> <span class="p">(</span><span class="n">pvals_chi2</span> <span class="o">-</span> <span class="n">pvals_z</span><span class="p">)</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">plot_experiment</span><span class="p">(</span><span class="n">pvals_diffs</span><span class="p">)</span>
</code></pre></div>

<p><img alt="png" src="../../../../../images/compare_z_and_chi_square_tests_38_0.png"></p>
<div class="highlight"><pre><span></span><code><span class="n">plot_experiment</span><span class="p">(</span><span class="n">pvals_diffs_close</span><span class="o">.</span><span class="n">applymap</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="mi">1</span><span class="p">))</span>
</code></pre></div>

<p><img alt="png" src="../../../../../images/compare_z_and_chi_square_tests_39_0.png"></p>
<p>So we see that except a single(!) case, all <span class="math">\(p\)</span>-values are the same!</p>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/latest.js?config=TeX-AMS-MML_HTMLorMML';

    var configscript = document.createElement('script');
    configscript.type = 'text/x-mathjax-config';
    configscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['MMLorHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'none' } }," +
        "    jax: ['input/TeX','input/MathML','output/HTML-CSS']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        availableFonts: ['STIX', 'TeX']," +
        "        preferredFont: 'STIX'," +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";

    (document.body || document.getElementsByTagName('head')[0]).appendChild(configscript);
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script>
  </div>
</article>
  <hr>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function() {
      this.page.url = '../../../../../posts/2018/Feb/19/comparing-z-and-chi2-tests/index.html';
      this.page.identifier = 'comparing-z-and-chi2-tests';
    };
    (function() {
      var d = document;
      var s = d.createElement('script');
      s.src = '//dr-dror.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript class="text-muted">
    Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
  </noscript>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
    <li class="list-inline-item"><a href="../../../../../archives.html">Archives</a></li>
    <li class="list-inline-item"><a href="../../../../../categories.html">Categories</a></li>
      <li class="list-inline-item"><a href="../../../../../tags.html">Tags</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
  </p>
</div>    </div>
  </footer>

</body>

</html>