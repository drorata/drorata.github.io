<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


  <title>Averages, sums and counts when grouping by | Dr. Dror
</title>
  <link rel="canonical" href="../../../../../posts/2017/Aug/28/averages-sums-and-counts-when-grouping-by/index.html">


  <link rel="stylesheet" href="../../../../../theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="../../../../../theme/css/fontawesome.min.css">
  <link rel="stylesheet" href="../../../../../theme/css/pygments/default.min.css">
  <link rel="stylesheet" href="../../../../../theme/css/theme.css">


<meta name="description" content="A gotcha when aggregated time series data involving hourly based counts.">
  <!-- Global site tag (gtag.js) - Google Analytics --> 
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-WH47T9F1TR"></script> 
  <script> 
    window.dataLayer = window.dataLayer || []; 
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date()); 

    gtag('config', 'G-WH47T9F1TR'); 
  </script>


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
    <div class="col-sm-4">
      <a href="../../../../../">
        <img class="img-fluid rounded" src=../../../../../images/colored-spiral-of-roots.png width=90 height=90 alt="Dr. Dror">
      </a>
    </div>
  <div class="col-sm-8">
    <h1 class="title"><a href="../../../../../">Dr. Dror</a></h1>
      <p class="text-muted">Foo is not just a "Bar"</p>
      <ul class="list-inline">
            <li class="list-inline-item"><a href="../../../../../pages/about.html">About</a></li>
              <li class="list-inline-item text-muted">/</li>
            <li class="list-inline-item"><a href="../../../../../pages/random-work.html">Random work</a></li>
            <li class=" list-inline-item text-muted">|</li>
          <li class="list-inline-item"><a class="fab fa-github" href="https://github.com/drorata" target="_blank"></a></li>
          <li class="list-inline-item"><a class="fab fa-linkedin" href="https://www.linkedin.com/in/atariah" target="_blank"></a></li>
      </ul>
  </div>
</div>    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>  Averages, sums and counts when grouping by
</h1>
      <hr>
<article class="article">
  <header>
    <ul class="list-inline">
      <li class="list-inline-item text-muted" title="2017-08-28T00:00:00+02:00">
        <i class="fas fa-clock"></i>
        Mon 28 August 2017
      </li>
      <li class="list-inline-item">
        <i class="fas fa-folder-open"></i>
        <a href="../../../../../category/howto.html">HowTo</a>
      </li>
      <li class="list-inline-item">
        <i class="fas fa-tag"></i>
        <a href="../../../../../tag/python.html">#python</a>,         <a href="../../../../../tag/pandas.html">#pandas</a>      </li>
    </ul>
  </header>
  <div class="content">
    <p>(Original notebook can be found in <a href="https://gist.github.com/drorata/bb63e87c9baa3d5bc1fc088d43bee8f3">this gist</a>)</p>
<h1 id="averages-sums-and-counts-when-grouping-by">Averages, sums and counts when grouping by</h1>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</code></pre></div>

<p>Assume we have a table where each row corresponds to a transaction and indexed by timestamp.
By re-sampling this table by <code>1H</code> frequency and counting the number of transaction per hour, we get a new aggregated view when each row corresponds to an hour and the value is the count of transaction happened within that hour.</p>
<p>As an example, we start with the following table.
This demonstrates the result of the re-sampling mentioned above.</p>
<div class="highlight"><pre><span></span><code><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="s1">&#39;2017-01-01&#39;</span><span class="p">,</span> <span class="s1">&#39;2017-01-14&#39;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;1H&#39;</span><span class="p">)</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre></div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-01-01 00:00:00</th>
      <td>4</td>
    </tr>
    <tr>
      <th>2017-01-01 01:00:00</th>
      <td>5</td>
    </tr>
    <tr>
      <th>2017-01-01 02:00:00</th>
      <td>3</td>
    </tr>
    <tr>
      <th>2017-01-01 03:00:00</th>
      <td>5</td>
    </tr>
    <tr>
      <th>2017-01-01 04:00:00</th>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>

<p>The objective is to measure behavior as depending on the day of the week (Mo., Tue. etc.)
First, let us count how many events happened during each weekday.
This can be achieved in couple of ways:</p>
<div class="highlight"><pre><span></span><code><span class="n">df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;sum&#39;</span><span class="p">)</span>
</code></pre></div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>161</td>
    </tr>
    <tr>
      <th>1</th>
      <td>170</td>
    </tr>
    <tr>
      <th>2</th>
      <td>164</td>
    </tr>
    <tr>
      <th>3</th>
      <td>133</td>
    </tr>
    <tr>
      <th>4</th>
      <td>169</td>
    </tr>
    <tr>
      <th>5</th>
      <td>98</td>
    </tr>
    <tr>
      <th>6</th>
      <td>172</td>
    </tr>
  </tbody>
</table>
</div>

<p>or:</p>
<div class="highlight"><pre><span></span><code><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</code></pre></div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>161</td>
    </tr>
    <tr>
      <th>1</th>
      <td>170</td>
    </tr>
    <tr>
      <th>2</th>
      <td>164</td>
    </tr>
    <tr>
      <th>3</th>
      <td>133</td>
    </tr>
    <tr>
      <th>4</th>
      <td>169</td>
    </tr>
    <tr>
      <th>5</th>
      <td>98</td>
    </tr>
    <tr>
      <th>6</th>
      <td>172</td>
    </tr>
  </tbody>
</table>
</div>

<p>Lastly, being more explicit (and less Pythonic):</p>
<div class="highlight"><pre><span></span><code><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span><span class="o">==</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
    <span class="p">],</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>161</td>
    </tr>
    <tr>
      <th>1</th>
      <td>170</td>
    </tr>
    <tr>
      <th>2</th>
      <td>164</td>
    </tr>
    <tr>
      <th>3</th>
      <td>133</td>
    </tr>
    <tr>
      <th>4</th>
      <td>169</td>
    </tr>
    <tr>
      <th>5</th>
      <td>98</td>
    </tr>
    <tr>
      <th>6</th>
      <td>172</td>
    </tr>
  </tbody>
</table>
</div>

<p>Next, we want to compute the <em>average</em> number of transaction per weekday.
First, let's do it explicitly, for Monday (day 0).
The total number of transactions is:</p>
<div class="highlight"><pre><span></span><code><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nx">count</span><span class="w">    </span><span class="mi">161</span>
<span class="nx">dtype</span><span class="p">:</span><span class="w"> </span><span class="nx">int64</span>
</code></pre></div>

<p>In the dates range used, there are two Mondays, therefore, the average is:</p>
<div class="highlight"><pre><span></span><code><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;1d&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="mf">2</span>
</code></pre></div>

<p>Therefore, the average is:</p>
<div class="highlight"><pre><span></span><code><span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;1d&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="nx">count</span><span class="w">    </span><span class="m m-Double">80.5</span>
<span class="nx">dtype</span><span class="p">:</span><span class="w"> </span><span class="nx">float64</span>
</code></pre></div>

<p>One may think the following syntax is a quicker way:</p>
<div class="highlight"><pre><span></span><code><span class="n">df</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span><span class="p">,</span> <span class="n">aggfunc</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">)</span>
</code></pre></div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3.354167</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3.541667</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3.416667</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2.770833</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3.520833</td>
    </tr>
    <tr>
      <th>5</th>
      <td>3.920000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>3.583333</td>
    </tr>
  </tbody>
</table>
</div>

<p>But this returns the wrong average.
To be more precise, it divides the number of transactions per day-of-week by the number of hours that occurred in this day-of-week in the time range, given by:</p>
<div class="highlight"><pre><span></span><code><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</code></pre></div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>48</td>
    </tr>
    <tr>
      <th>1</th>
      <td>48</td>
    </tr>
    <tr>
      <th>2</th>
      <td>48</td>
    </tr>
    <tr>
      <th>3</th>
      <td>48</td>
    </tr>
    <tr>
      <th>4</th>
      <td>48</td>
    </tr>
    <tr>
      <th>5</th>
      <td>25</td>
    </tr>
    <tr>
      <th>6</th>
      <td>48</td>
    </tr>
  </tbody>
</table>
</div>

<p>Or, put together:</p>
<div class="highlight"><pre><span></span><code><span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</code></pre></div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3.354167</td>
    </tr>
    <tr>
      <th>1</th>
      <td>3.541667</td>
    </tr>
    <tr>
      <th>2</th>
      <td>3.416667</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2.770833</td>
    </tr>
    <tr>
      <th>4</th>
      <td>3.520833</td>
    </tr>
    <tr>
      <th>5</th>
      <td>3.920000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>3.583333</td>
    </tr>
  </tbody>
</table>
</div>

<p>A way around it, would be:</p>
<div class="highlight"><pre><span></span><code><span class="n">count_per_day_df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">&#39;1d&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">count_per_day_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">count_per_day_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofweek</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</code></pre></div>

<div>
<style>
    .dataframe thead tr:only-child th {
        text-align: right;
    }

    .dataframe thead th {
        text-align: left;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>count</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>80.5</td>
    </tr>
    <tr>
      <th>1</th>
      <td>85.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>82.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>66.5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>84.5</td>
    </tr>
    <tr>
      <th>5</th>
      <td>49.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>86.0</td>
    </tr>
  </tbody>
</table>
</div>

<p>I mentioned this maybe counter intuitive behavior on <a href="https://stackoverflow.com/q/45922291/671013">SO</a>.</p>
  </div>
</article>
  <hr>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function() {
      this.page.url = '../../../../../posts/2017/Aug/28/averages-sums-and-counts-when-grouping-by/index.html';
      this.page.identifier = 'averages-sums-and-counts-when-grouping-by';
    };
    (function() {
      var d = document;
      var s = d.createElement('script');
      s.src = '//dr-dror.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript class="text-muted">
    Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
  </noscript>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
    <li class="list-inline-item"><a href="../../../../../archives.html">Archives</a></li>
    <li class="list-inline-item"><a href="../../../../../categories.html">Categories</a></li>
      <li class="list-inline-item"><a href="../../../../../tags.html">Tags</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
  </p>
</div>    </div>
  </footer>

</body>

</html>