<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">


  <title>Useful Docker hints | Dr. Dror
</title>
  <link rel="canonical" href="../../../../../posts/2017/Apr/04/useful-docker-hints/index.html">


  <link rel="stylesheet" href="../../../../../theme/css/bootstrap.min.css">
  <link rel="stylesheet" href="../../../../../theme/css/fontawesome.min.css">
  <link rel="stylesheet" href="../../../../../theme/css/pygments/default.min.css">
  <link rel="stylesheet" href="../../../../../theme/css/theme.css">


<meta name="description" content="Recently, I started to use and get to know Docker. One of my central motivations is to utilize this technology for the creation of reproducible research/work. The first minimal working example I came up with contains a notebook which loads the data from a CSV file which is part …">
  <!-- Global site tag (gtag.js) - Google Analytics --> 
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-WH47T9F1TR"></script> 
  <script> 
    window.dataLayer = window.dataLayer || []; 
    function gtag(){dataLayer.push(arguments);} 
    gtag('js', new Date()); 

    gtag('config', 'G-WH47T9F1TR'); 
  </script>


</head>

<body>
  <header class="header">
    <div class="container">
<div class="row">
    <div class="col-sm-4">
      <a href="../../../../../">
        <img class="img-fluid rounded" src=../../../../../images/colored-spiral-of-roots.png width=90 height=90 alt="Dr. Dror">
      </a>
    </div>
  <div class="col-sm-8">
    <h1 class="title"><a href="../../../../../">Dr. Dror</a></h1>
      <p class="text-muted">Foo is not just a "Bar"</p>
      <ul class="list-inline">
            <li class="list-inline-item"><a href="../../../../../pages/about.html">About</a></li>
              <li class="list-inline-item text-muted">/</li>
            <li class="list-inline-item"><a href="../../../../../pages/random-work.html">Random work</a></li>
            <li class=" list-inline-item text-muted">|</li>
          <li class="list-inline-item"><a class="fab fa-github" href="https://github.com/drorata" target="_blank"></a></li>
          <li class="list-inline-item"><a class="fab fa-linkedin" href="https://www.linkedin.com/in/atariah" target="_blank"></a></li>
      </ul>
  </div>
</div>    </div>
  </header>

  <div class="main">
    <div class="container">
      <h1>  Useful Docker hints
</h1>
      <hr>
<article class="article">
  <header>
    <ul class="list-inline">
      <li class="list-inline-item text-muted" title="2017-04-04T00:00:00+02:00">
        <i class="fas fa-clock"></i>
        Tue 04 April 2017
      </li>
      <li class="list-inline-item">
        <i class="fas fa-folder-open"></i>
        <a href="../../../../../category/howto.html">HowTo</a>
      </li>
      <li class="list-inline-item">
        <i class="fas fa-tag"></i>
        <a href="../../../../../tag/docker.html">#docker</a>,         <a href="../../../../../tag/reproducible.html">#reproducible</a>,         <a href="../../../../../tag/research.html">#research</a>,         <a href="../../../../../tag/jupyter.html">#jupyter</a>      </li>
    </ul>
  </header>
  <div class="content">
    <p>Recently, I started to use and get to know <a href="https://www.docker.com/">Docker</a>.
One of my central motivations is to utilize this technology for the creation of reproducible research/work.
The first minimal working example I came up with contains a notebook which loads the data from a CSV file which is part of the image.
You can see the details <a href="https://github.com/drorata/mwe-jupyter-docker">here</a>.
While preparing this image, I came across many useful items; I collected some of them in this post.</p>
<h2 id="connecting-two-containers-over-network-1">Connecting two containers over network <sup id="fnref:7e76b2d7"><a class="footnote-ref" href="#fn:7e76b2d7">1</a></sup></h2>
<p>First, start a new network:</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>network<span class="w"> </span>create<span class="w"> </span>new-network
</code></pre></div>

<p>Next, start the two containers as follow:</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-i<span class="w"> </span>-t<span class="w"> </span>--name<span class="w"> </span>cont1<span class="w"> </span>--net<span class="o">=</span>new-network<span class="w"> </span>--net-alias<span class="o">=</span>cont1<span class="w"> </span>drorata/base-image<span class="w"> </span>/bin/bash
docker<span class="w"> </span>run<span class="w"> </span>-i<span class="w"> </span>-t<span class="w"> </span>--name<span class="w"> </span>cont2<span class="w"> </span>--net<span class="o">=</span>new-network<span class="w"> </span>--net-alias<span class="o">=</span>cont2<span class="w"> </span>drorata/base-image<span class="w"> </span>/bin/bash
</code></pre></div>

<h2 id="stop-remove-all-running-containers-2">Stop / Remove all running containers <sup id="fnref:15cde0e3"><a class="footnote-ref" href="#fn:15cde0e3">2</a></sup></h2>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>stop<span class="w"> </span><span class="k">$(</span>docker<span class="w"> </span>ps<span class="w"> </span>-a<span class="w"> </span>-q<span class="k">)</span>
</code></pre></div>

<p>The last part generates a list of IDs and in turn this list is passed to the <code>stop</code> command.
Similarly,</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>rm<span class="w"> </span><span class="k">$(</span>docker<span class="w"> </span>ps<span class="w"> </span>-a<span class="w"> </span>-q<span class="k">)</span>
</code></pre></div>

<p>will remove all the stoped containers.
You can use the <code>-f</code> option for the <code>rm</code> for (brutally) stopping and removing all containers.</p>
<h2 id="leave-a-container-and-keep-in-alive">Leave a container and keep in alive</h2>
<p>If you start a new container in interactive mode and enter the shell, like in <code>docker run -i -t ubuntu</code>, and exit it, Docker will stop the container.
You can check it using <code>docker ps -a</code>.
The reason is that the process you asked has terminated and the container is stopped.
To avoid it, you can hit <code>CTRL+P CTRL+Q</code>.
See this short and excellent <a href="http://stackoverflow.com/questions/25267372/correct-way-to-detach-from-a-container-without-stopping-it">answer</a> and don't forget to read also <a href="http://stackoverflow.com/a/25268154/671013">this one</a>.</p>
<h2 id="using-anaconda-from-docker">Using Anaconda from Docker</h2>
<p>First, you can run a simple container having full–fledged Anaconda installation.
It is as simple as</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-i<span class="w"> </span>-t<span class="w"> </span>--name<span class="w"> </span>conda-base<span class="w"> </span>continuumio/anaconda3<span class="w"> </span>/bin/bash
</code></pre></div>

<p>Once running, you can python in the container as much as you want.
As Jupyter is an important part of the work, let's discuss how to use it.
From the container's terminal you can start Jupyter but that won't be enough.
The <code>localhost</code> of the container is not the same as of the host OS.
We'd have to enable port forwarding:</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-i<span class="w"> </span>-t<span class="w"> </span>-p<span class="w"> </span><span class="m">8888</span>:8888<span class="w"> </span>--name<span class="w"> </span>conda-base<span class="w"> </span>continuumio/anaconda3<span class="w"> </span>/bin/bash
</code></pre></div>

<p>Next, in the new container's shell run</p>
<div class="highlight"><pre><span></span><code>jupyter<span class="w"> </span>notebook<span class="w"> </span>--ip<span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="w"> </span>--port<span class="o">=</span><span class="m">8888</span><span class="w"> </span>--no-browser
</code></pre></div>

<p>Go to the address where the notebook is served and enjoy.
There's one thing missing still, the nice notebooks don't have a place to be saved.
They can be saved of course in the container, but they won't persists once you stop it.
You should mount a local directory (on the host) as a data volume:</p>
<div class="highlight"><pre><span></span><code>docker run -i -t -p 8888:8888 --name conda-base -v ~/tmp:/opt/notebooks continuumio/anaconda3 /bin/bash
</code></pre></div>

<p>and inside the container, execute:</p>
<div class="highlight"><pre><span></span><code>jupyter<span class="w"> </span>notebook<span class="w"> </span>--notebook-dir<span class="o">=</span>/opt/notebooks<span class="w"> </span>--ip<span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="w"> </span>--port<span class="o">=</span><span class="m">8888</span><span class="w"> </span>--no-browser
</code></pre></div>

<p>Now, what ever notebook you save from within the container, it will be also available on <code>~/tmp</code>.
If, for some reason, the container stopped, you can reuse it: <code>docker exec -it conda-base /bin/bash</code>.
Lastly, putting everything together, you can instantiate a new container as follow:</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-i<span class="w"> </span>-t<span class="w"> </span>-p<span class="w"> </span><span class="m">8888</span>:8888<span class="w"> </span>-v<span class="w"> </span>~/tmp:/opt/notebooks<span class="w"> </span>--name<span class="w"> </span>conda-base<span class="w"> </span>continuumio/anaconda3<span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;/opt/conda/bin/jupyter notebook --notebook-dir=/opt/notebooks --ip=&#39;*&#39; --port=8888 --no-browser&quot;</span>
</code></pre></div>

<h3 id="references">References</h3>
<ul>
<li><a href="https://docs.docker.com/engine/tutorials/dockervolumes/#mount-a-host-directory-as-a-data-volume">Mounting local directory</a></li>
<li><a href="https://www.continuum.io/blog/developer-blog/anaconda-and-docker-better-together-reproducible-data-science">Running notebook from a container</a></li>
</ul>
<h2 id="location-of-images-3">Location of images <sup id="fnref:167a330e"><a class="footnote-ref" href="#fn:167a330e">3</a></sup></h2>
<p>On Mac images are stored in a file</p>
<div class="highlight"><pre><span></span><code><span class="nv">$HOME</span>/Library/Containers/com.docker.docker/Data/com.docker.driver.amd64-linux/Docker.qcow2
</code></pre></div>

<h2 id="running-pyspark-within-jupyter">Running PySpark within Jupyter</h2>
<p>The <a href="https://github.com/jupyter/docker-stacks/tree/master/pyspark-notebook">pyspark-notebook</a> image seems to be a simple and straightforward way to get started with Spark.
Simply run:</p>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-it<span class="w"> </span>--rm<span class="w"> </span>-p<span class="w"> </span><span class="m">8888</span>:8888<span class="w"> </span>jupyter/pyspark-notebook
</code></pre></div>

<p>Naturally, you can also mount a local directory for persiting the generated notebooks.</p>
<div class="footnote">
<hr>
<ol>
<li id="fn:7e76b2d7">
<p><a href="http://stackoverflow.com/questions/25324860/how-to-create-a-bidirectional-link-between-containers/35577068#35577068">source</a>&#160;<a class="footnote-backref" href="#fnref:7e76b2d7" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:15cde0e3">
<p><a href="https://coderwall.com/p/ewk0mq/stop-remove-all-docker-containers">source</a>&#160;<a class="footnote-backref" href="#fnref:15cde0e3" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:167a330e">
<p><a href="https://forums.docker.com/t/where-are-images-stored-on-mac-os-x/17165/2">source</a>&#160;<a class="footnote-backref" href="#fnref:167a330e" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
  </div>
</article>
  <hr>
  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function() {
      this.page.url = '../../../../../posts/2017/Apr/04/useful-docker-hints/index.html';
      this.page.identifier = 'useful-docker-hints';
    };
    (function() {
      var d = document;
      var s = d.createElement('script');
      s.src = '//dr-dror.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript class="text-muted">
    Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
  </noscript>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
<div class="row">
  <ul class="col-sm-6 list-inline">
    <li class="list-inline-item"><a href="../../../../../archives.html">Archives</a></li>
    <li class="list-inline-item"><a href="../../../../../categories.html">Categories</a></li>
      <li class="list-inline-item"><a href="../../../../../tags.html">Tags</a></li>
  </ul>
  <p class="col-sm-6 text-sm-right text-muted">
    Generated by <a href="https://github.com/getpelican/pelican" target="_blank">Pelican</a>
    / <a href="https://github.com/nairobilug/pelican-alchemy" target="_blank">&#x2728;</a>
  </p>
</div>    </div>
  </footer>

</body>

</html>